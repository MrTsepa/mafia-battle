<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Game - Live View</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 300px 1fr 350px 250px;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        .game-state {
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 300px 1fr 350px 250px;
            gap: 20px;
            margin-bottom: 20px;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        h2 {
            font-size: 1.3em;
            margin-bottom: 15px;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 8px;
        }

        .status-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 0.9em;
            margin: 5px 0;
        }

        .phase-day {
            background: #4CAF50;
            color: white;
        }

        .phase-night {
            background: #2c3e50;
            color: white;
        }

        .phase-voting {
            background: #e74c3c;
            color: white;
        }

        .phase-game-over {
            background: #9b59b6;
            color: white;
        }

        .player-list {
            list-style: none;
        }

        .player-item {
            padding: 10px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f8f9fa;
            transition: transform 0.2s;
        }

        .player-item:hover {
            transform: translateX(5px);
        }

        .player-alive {
            border-left-color: #4CAF50;
        }

        .player-eliminated {
            border-left-color: #e74c3c;
            opacity: 0.6;
        }

        .team-red {
            border-left-color: #e74c3c;
        }

        .team-black {
            border-left-color: #2c3e50;
        }

        .player-number {
            font-weight: bold;
            font-size: 1.1em;
            color: #667eea;
        }

        .player-role {
            font-size: 0.9em;
            color: #666;
            margin-top: 4px;
        }

        .event-log {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f8f9fa;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .event-speech {
            border-left-color: #3498db;
            background: #ebf5fb;
        }

        .event-nomination {
            border-left-color: #f39c12;
            background: #fef5e7;
        }

        .event-vote {
            border-left-color: #9b59b6;
            background: #f4ecf7;
        }

        .event-elimination {
            border-left-color: #e74c3c;
            background: #fadbd8;
        }

        .event-night-action {
            border-left-color: #2c3e50;
            background: #eaeded;
        }

        .event-announcement {
            border-left-color: #95a5a6;
            background: #ecf0f1;
            font-style: italic;
        }

        .event-time {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 4px;
        }

        .event-content {
            line-height: 1.6;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.9em;
            color: #666;
            margin-top: 5px;
        }

        .connection-status {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 20px;
            border-radius: 20px;
            font-weight: bold;
            z-index: 1000;
        }

        .connected {
            background: #4CAF50;
            color: white;
        }

        .disconnected {
            background: #e74c3c;
            color: white;
        }

        .winner-banner {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.5em;
            font-weight: bold;
            margin-bottom: 20px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                transform: scale(1);
            }
            50% {
                transform: scale(1.02);
            }
        }

        .player-speech {
            font-weight: 500;
            color: #2c3e50;
        }

        .player-name {
            font-weight: bold;
            color: #667eea;
        }

        .error-banner {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 20px;
            animation: shake 0.5s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        .error-details {
            font-size: 0.9em;
            margin-top: 10px;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <h1>üé≠ Mafia Game - Live View</h1>
    
    <div class="connection-status" id="connectionStatus">
        <span id="statusText">Connecting...</span>
    </div>

    <div style="max-width: 1400px; margin: 0 auto; padding: 0 20px;">
        <div id="errorBanner" style="display: none;"></div>
    </div>

    <div class="container" id="container">
        <div class="game-state">
            <div class="panel">
                <h2>Game Status</h2>
                <div id="gameStatus">
                    <div class="status-badge phase-day" id="phaseBadge">DAY 1</div>
                    <div style="margin-top: 15px;">
                        <strong>Day:</strong> <span id="dayNumber">1</span><br>
                        <strong>Night:</strong> <span id="nightNumber">0</span>
                    </div>
                </div>
                
                <h2 style="margin-top: 20px;">Statistics</h2>
                <div class="stats-grid">
                    <div class="stat-box">
                        <div class="stat-value" id="aliveCount">10</div>
                        <div class="stat-label">Alive</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="mafiaCount">3</div>
                        <div class="stat-label">Mafia</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="civilianCount">7</div>
                        <div class="stat-label">Civilians</div>
                    </div>
                    <div class="stat-box">
                        <div class="stat-value" id="eliminatedCount">0</div>
                        <div class="stat-label">Eliminated</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Event Log</h2>
                <div class="event-log" id="eventLog">
                    <div class="event-item event-announcement">
                        <div class="event-content">Waiting for game to start...</div>
                    </div>
                </div>
            </div>

            <div class="panel">
                <h2>Players</h2>
                <ul class="player-list" id="playerList">
                    <!-- Players will be populated here -->
                </ul>
            </div>

            <div class="panel">
                <h2>LLM Metadata</h2>
                <div id="metadataLog" style="max-height: calc(100vh - 200px); overflow-y: auto;">
                    <div style="font-size: 0.9em; color: #666; padding: 10px;">
                        Waiting for LLM calls...
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        const eventLog = document.getElementById('eventLog');
        const playerList = document.getElementById('playerList');
        const metadataLog = document.getElementById('metadataLog');
        const connectionStatus = document.getElementById('connectionStatus');
        const statusText = document.getElementById('statusText');

        let players = [];
        let gameState = {
            phase: 'setup',
            day_number: 0,
            night_number: 0,
            alive_count: 10,
            mafia_count: 3,
            civilian_count: 7
        };

        // Connection status
        socket.on('connect', () => {
            statusText.textContent = 'Connected';
            connectionStatus.className = 'connection-status connected';
        });

        socket.on('disconnect', () => {
            statusText.textContent = 'Disconnected';
            connectionStatus.className = 'connection-status disconnected';
        });

        // Game state update
        socket.on('game_state_update', (data) => {
            gameState = data.game_state || data;
            updateGameStatus();
            if (data.players) {
                players = data.players;
                updatePlayerList();
            }
        });

        // Phase change
        socket.on('phase_change', (data) => {
            gameState.phase = data.phase;
            gameState.day_number = data.day_number;
            gameState.night_number = data.night_number;
            updateGameStatus();
            addEvent('announcement', `Phase changed to ${data.phase.toUpperCase()} - Day ${data.day_number}, Night ${data.night_number}`);
        });

        // Game start
        socket.on('game_start', (data) => {
        addEvent('announcement', `Game started! Players: ${data.players.join(', ')}`);
        addEvent('announcement', `Mafia: ${data.mafia.join(', ')} | Sheriff: ${data.sheriff}`);
        });

        // Speech
        socket.on('speech', (data) => {
        addEvent('speech', `Player ${data.player_number}: ${data.speech}`);
        });

        // Nomination
        socket.on('nomination', (data) => {
        if (data.success) {
            addEvent('nomination', `Player ${data.nominator} nominated Player ${data.target}`);
        } else {
            addEvent('nomination', `Player ${data.nominator}'s nomination of Player ${data.target} was rejected`);
        }
        });

        // Voting
        socket.on('voting_start', (data) => {
        addEvent('announcement', `Voting started! Nominated players: ${data.nominations.join(', ')}`);
        });

        socket.on('vote', (data) => {
        addEvent('vote', `Player ${data.voter} voted for Player ${data.target}`);
        });

        socket.on('vote_results', (data) => {
        let results = 'Vote results: ';
        for (const [player, count] of Object.entries(data.vote_counts)) {
            results += `Player ${player}: ${count} votes; `;
        }
        addEvent('vote', results);
        });

        socket.on('tie', (data) => {
        addEvent('announcement', `Tie detected between players: ${data.tied_players.join(', ')}`);
        });

        // Elimination
        socket.on('elimination', (data) => {
        let reason = data.reason;
        if (data.voters && data.voters.length > 0) {
            reason += ` (voted by: ${data.voters.join(', ')})`;
        }
        addEvent('elimination', `Player ${data.player_number} eliminated - ${reason}`);
        updatePlayerList();
        });

        // Night actions
        socket.on('night_kill_claim', (data) => {
        addEvent('night-action', `[MAFIA] Player ${data.player_number} claims kill on Player ${data.target}`);
        });

        socket.on('night_kill_decision', (data) => {
        const role = data.is_don ? 'DON' : 'MAFIA';
        addEvent('night-action', `[${role}] Decides to kill Player ${data.target}`);
        });

        socket.on('don_check', (data) => {
        addEvent('night-action', `[DON] Checked Player ${data.target}: ${data.result}`);
        });

        socket.on('sheriff_check', (data) => {
        addEvent('night-action', `[SHERIFF] Checked Player ${data.target}: ${data.result}`);
        });

        // Announcements
        socket.on('announcement', (data) => {
            addEvent('announcement', `[JUDGE] ${data.message}`);
        });

        // LLM Metadata
        socket.on('llm_metadata', (data) => {
            addMetadata(data);
        });

        // Fatal error
        socket.on('fatal_error', (data) => {
        const errorBanner = document.getElementById('errorBanner');
        if (errorBanner) {
            errorBanner.className = 'error-banner';
            let errorHtml = `‚ùå FATAL ERROR: ${escapeHtml(data.error_message)}`;
            if (data.player_number) {
                errorHtml += `<div class="error-details">Player: ${data.player_number}`;
                if (data.action_type) {
                    errorHtml += ` | Action: ${escapeHtml(data.action_type)}`;
                }
                errorHtml += `</div>`;
            }
            errorBanner.innerHTML = errorHtml;
            errorBanner.style.display = 'block';
        }
        
        // Also add to event log
        addEvent('elimination', `FATAL ERROR: ${data.error_message}`);
        });

        // Game over
        socket.on('game_over', (data) => {
        if (data.reason === 'failed') {
            const errorBanner = document.getElementById('errorBanner');
            if (errorBanner && errorBanner.style.display === 'none') {
                errorBanner.className = 'error-banner';
                errorBanner.innerHTML = '‚ùå GAME FAILED - Fatal Error Occurred';
                errorBanner.style.display = 'block';
            }
            addEvent('announcement', 'GAME FAILED - Fatal Error');
        } else {
            const winner = data.winner === 'red' ? 'Civilians (Red Team)' : 'Mafia (Black Team)';
            addEvent('announcement', `GAME OVER - ${winner} WIN!`);
        }
        updateGameStatus();
        });

        function updateGameStatus() {
            const phaseBadge = document.getElementById('phaseBadge');
        const dayNumber = document.getElementById('dayNumber');
        const nightNumber = document.getElementById('nightNumber');
        const aliveCount = document.getElementById('aliveCount');
        const mafiaCount = document.getElementById('mafiaCount');
        const civilianCount = document.getElementById('civilianCount');
        const eliminatedCount = document.getElementById('eliminatedCount');

        const phase = gameState.phase || 'setup';
        const phaseClass = `phase-${phase.replace('_', '-')}`;
        phaseBadge.className = `status-badge ${phaseClass}`;
        phaseBadge.textContent = phase.toUpperCase().replace('_', ' ');

        dayNumber.textContent = gameState.day_number || 0;
        nightNumber.textContent = gameState.night_number || 0;
        aliveCount.textContent = gameState.alive_count || 0;
        mafiaCount.textContent = gameState.mafia_count || 0;
        civilianCount.textContent = gameState.civilian_count || 0;
        eliminatedCount.textContent = (gameState.alive_count ? 10 - gameState.alive_count : 0);
        }

        function updatePlayerList() {
        playerList.innerHTML = '';
        players.forEach(player => {
            const li = document.createElement('li');
            li.className = `player-item ${player.is_alive ? 'player-alive' : 'player-eliminated'} team-${player.team.toLowerCase()}`;
            
            const roleDisplay = player.is_alive ? 'Unknown' : player.role;
            li.innerHTML = `
                <div class="player-number">Player ${player.number}</div>
                <div class="player-role">${roleDisplay} (${player.team})</div>
                <div style="font-size: 0.8em; color: #999; margin-top: 4px;">
                    ${player.is_alive ? '‚úì Alive' : '‚úó Eliminated'}
                </div>
            `;
            
            playerList.appendChild(li);
        });
        }

        function addEvent(type, message) {
        const eventItem = document.createElement('div');
        eventItem.className = `event-item event-${type}`;
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString();
        
        eventItem.innerHTML = `
            <div class="event-time">${timeStr}</div>
            <div class="event-content">${escapeHtml(message)}</div>
        `;
        
        eventLog.insertBefore(eventItem, eventLog.firstChild);
        
        // Keep only last 200 events
        while (eventLog.children.length > 200) {
            eventLog.removeChild(eventLog.lastChild);
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function addMetadata(data) {
            // Clear "waiting" message if present
            if (metadataLog.children.length === 1 && metadataLog.children[0].textContent.includes('Waiting')) {
                metadataLog.innerHTML = '';
            }

            const metadataItem = document.createElement('div');
            metadataItem.style.cssText = 'padding: 10px; margin: 8px 0; border-radius: 8px; background: #f8f9fa; border-left: 4px solid #667eea; font-size: 0.85em;';
            
            const now = new Date();
            const timeStr = now.toLocaleTimeString();
            
            const promptTokens = data.prompt_tokens || 0;
            const completionTokens = data.completion_tokens || 0;
            const totalTokens = data.total_tokens || 0;
            const latency = data.latency_ms ? data.latency_ms.toFixed(0) : 'N/A';
            
            metadataItem.innerHTML = `
                <div style="color: #999; font-size: 0.8em; margin-bottom: 4px;">${timeStr}</div>
                <div style="font-weight: bold; color: #667eea; margin-bottom: 4px;">Player ${data.player_number} - ${escapeHtml(data.action_type || 'llm_call')}</div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 8px;">
                    <div><strong>Prompt:</strong> ${promptTokens.toLocaleString()}</div>
                    <div><strong>Completion:</strong> ${completionTokens.toLocaleString()}</div>
                    <div><strong>Total:</strong> ${totalTokens.toLocaleString()}</div>
                    <div><strong>Latency:</strong> ${latency}ms</div>
                </div>
                <div style="margin-top: 4px; color: #666; font-size: 0.8em;">Model: ${escapeHtml(data.model || 'unknown')}</div>
            `;
            
            metadataLog.insertBefore(metadataItem, metadataLog.firstChild);
            
            // Keep only last 50 metadata entries
            while (metadataLog.children.length > 50) {
                metadataLog.removeChild(metadataLog.lastChild);
            }
        }

        // Initial update
        updateGameStatus();
    </script>
</body>
</html>

