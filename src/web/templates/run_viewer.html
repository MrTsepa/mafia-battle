<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mafia Game - Run Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: calc(100vh - 40px);
        }

        .panel {
            background: white;
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            overflow-y: auto;
        }

        h1 {
            color: white;
            text-align: center;
            margin-bottom: 20px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }

        h2 {
            font-size: 1.1em;
            margin-bottom: 8px;
            margin-top: 0;
            color: #667eea;
            border-bottom: 2px solid #667eea;
            padding-bottom: 4px;
        }

        .run-list {
            list-style: none;
        }

        .run-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            background: #f8f9fa;
            cursor: pointer;
            transition: transform 0.2s, background 0.2s;
        }

        .run-item:hover {
            transform: translateX(5px);
            background: #e9ecef;
        }

        .run-item.active {
            background: #667eea;
            color: white;
            border-left-color: #4c63d2;
        }

        .run-name {
            font-weight: bold;
            font-size: 1.1em;
        }

        .run-meta {
            font-size: 0.85em;
            color: #666;
            margin-top: 4px;
        }

        .run-item.active .run-meta {
            color: rgba(255, 255, 255, 0.9);
        }

        .outcome-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .outcome-civilians {
            background: #e74c3c;
            color: white;
        }

        .outcome-mafia {
            background: #2c3e50;
            color: white;
        }

        .outcome-draw {
            background: #95a5a6;
            color: white;
        }

        .outcome-failed {
            background: #e67e22;
            color: white;
        }

        .game-view {
            display: grid;
            grid-template-columns: 350px 1fr;
            gap: 20px;
        }

        .status-badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 16px;
            font-weight: bold;
            font-size: 0.85em;
            margin: 0;
        }

        .phase-day { background: #4CAF50; color: white; }
        .phase-night { background: #2c3e50; color: white; }
        .phase-voting { background: #e74c3c; color: white; }
        .phase-game-over { background: #9b59b6; color: white; }
        .phase-failed { background: #e67e22; color: white; }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 6px;
            margin-bottom: 0;
        }

        .stat-box {
            background: #f8f9fa;
            padding: 8px;
            border-radius: 6px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            line-height: 1.2;
        }

        .stat-label {
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }

        .event-log {
            max-height: calc(100vh - 200px);
            overflow-y: auto;
        }

        .event-item {
            padding: 12px;
            margin: 8px 0;
            border-radius: 8px;
            border-left: 4px solid;
            background: #f8f9fa;
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }

        .event-speech { border-left-color: #3498db; background: #ebf5fb; }
        .event-nomination { border-left-color: #f39c12; background: #fef5e7; }
        .event-vote { border-left-color: #9b59b6; background: #f4ecf7; }
        .event-elimination { border-left-color: #e74c3c; background: #fadbd8; }
        .event-night-action { border-left-color: #2c3e50; background: #eaeded; }
        .event-announcement { border-left-color: #95a5a6; background: #ecf0f1; font-style: italic; }
        .event-llm-metadata { border-left-color: #16a085; background: #d5f4e6; }

        .speech-expand-btn {
            margin-top: 8px;
            padding: 6px 12px;
            background: #3498db;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85em;
        }

        .speech-expand-btn:hover {
            background: #2980b9;
        }

        .context-panel {
            margin-top: 12px;
            padding: 12px;
            background: #f8f9fa;
            border-radius: 6px;
            border: 1px solid #dee2e6;
            font-size: 0.85em;
            max-height: 400px;
            overflow-y: auto;
        }

        .context-panel pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9em;
            line-height: 1.5;
        }

        .reasoning-text {
            background: #fff3cd;
            border-left: 3px solid #ffc107;
            padding: 8px;
            margin-bottom: 8px;
            border-radius: 4px;
        }

        .context-header {
            font-weight: bold;
            margin-bottom: 8px;
            color: #495057;
        }
        
        .metadata-details {
            font-size: 0.85em;
            margin-top: 8px;
            padding-top: 8px;
            border-top: 1px solid rgba(0,0,0,0.1);
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 5px;
        }

        .event-time {
            font-size: 0.8em;
            color: #999;
            margin-bottom: 4px;
        }

        .event-content {
            line-height: 1.6;
        }

        .player-list {
            list-style: none;
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 6px;
            max-height: calc(100vh - 400px);
            overflow-y: auto;
            margin-bottom: 0;
        }

        .player-item {
            padding: 6px 8px;
            margin: 0;
            border-radius: 6px;
            border-left: 3px solid;
            background: #f8f9fa;
            font-size: 0.85em;
            display: flex;
            flex-direction: column;
            gap: 2px;
        }

        .player-alive { border-left-color: #4CAF50; }
        .player-eliminated { border-left-color: #e74c3c; opacity: 0.6; }
        .team-red { border-left-color: #e74c3c; }
        .team-black { border-left-color: #2c3e50; }

        .no-run-selected {
            text-align: center;
            padding: 40px;
            color: white;
            font-size: 1.2em;
        }

        .refresh-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 15px;
            font-size: 0.9em;
        }

        .refresh-btn:hover {
            background: #5568d3;
        }
    </style>
</head>
<body>
    <h1>ðŸŽ­ Mafia Game - Run Viewer</h1>

    <div class="container">
        <div class="panel">
            <h2>Runs</h2>
            <button class="refresh-btn" onclick="loadRuns()">Refresh</button>
            <ul class="run-list" id="runList">
                <li style="padding: 20px; text-align: center; color: #666;">Loading runs...</li>
            </ul>
        </div>

        <div id="gameView" class="panel" style="display: none;">
            <div class="game-view">
                <div class="panel">
                    <h2>Players</h2>
                    <ul class="player-list" id="playerList">
                        <!-- Players will be populated here -->
                    </ul>
                    
                    <h2 style="margin-top: 15px;">Game Status</h2>
                    <div id="gameStatus">
                        <div class="status-badge phase-day" id="phaseBadge">-</div>
                        <div style="margin-top: 8px; font-size: 0.9em;">
                            <strong>Day:</strong> <span id="dayNumber">-</span> | 
                            <strong>Night:</strong> <span id="nightNumber">-</span>
                        </div>
                        <div id="gameOutcome" style="margin-top: 8px; font-size: 0.85em; font-weight: bold; display: none;"></div>
                    </div>
                    
                    <h2 style="margin-top: 15px;">Statistics</h2>
                    <div class="stats-grid">
                        <div class="stat-box">
                            <div class="stat-value" id="aliveCount">-</div>
                            <div class="stat-label">Alive</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="mafiaCount">-</div>
                            <div class="stat-label">Mafia</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="civilianCount">-</div>
                            <div class="stat-label">Civilians</div>
                        </div>
                        <div class="stat-box">
                            <div class="stat-value" id="eliminatedCount">-</div>
                            <div class="stat-label">Eliminated</div>
                        </div>
                    </div>
                </div>

                <div class="panel">
                    <h2>Event Log</h2>
                    <div class="event-log" id="eventLog">
                        <div class="event-item event-announcement">
                            <div class="event-content">Loading events...</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="noRunSelected" class="no-run-selected">
            <p>Select a run from the left panel to view</p>
        </div>
    </div>

    <script>
        let currentRun = null;
        let eventsLoaded = 0;
        let pollInterval = null;

        async function loadRuns() {
            try {
                const response = await fetch('/api/runs');
                const runs = await response.json();
                
                const runList = document.getElementById('runList');
                runList.innerHTML = '';
                
                if (runs.length === 0) {
                    runList.innerHTML = '<li style="padding: 20px; text-align: center; color: #666;">No runs found</li>';
                    return;
                }
                
                runs.forEach(run => {
                    const li = document.createElement('li');
                    li.className = 'run-item';
                    li.dataset.runName = run.name;
                    li.onclick = function() { selectRun(run.name, this); };
                    
                    const eventCount = run.event_count || 0;
                    const metadata = run.metadata || {};
                    const config = metadata.config || {};
                    const gameOutcome = run.game_outcome;
                    const gameFailed = run.game_failed || false;
                    
                    let outcomeBadge = '';
                    if (gameOutcome) {
                        let badgeClass = 'outcome-badge';
                        if (gameFailed) {
                            badgeClass += ' outcome-failed';
                        } else if (gameOutcome.includes('Civilians')) {
                            badgeClass += ' outcome-civilians';
                        } else if (gameOutcome.includes('Mafia')) {
                            badgeClass += ' outcome-mafia';
                        } else {
                            badgeClass += ' outcome-draw';
                        }
                        outcomeBadge = `<div class="${badgeClass}">${escapeHtml(gameOutcome)}</div>`;
                    }
                    
                    li.innerHTML = `
                        <div class="run-name">${escapeHtml(run.name)}</div>
                        <div class="run-meta">
                            ${outcomeBadge}
                            ${eventCount} events<br>
                            ${config.llm_model ? 'Model: ' + config.llm_model : ''}
                        </div>
                    `;
                    
                    runList.appendChild(li);
                });
            } catch (error) {
                console.error('Error loading runs:', error);
            }
        }

        async function selectRun(runName, element) {
            currentRun = runName;
            eventsLoaded = 0;
            
            // Update active state
            document.querySelectorAll('.run-item').forEach(item => {
                item.classList.remove('active');
            });
            if (element) {
                element.classList.add('active');
            } else {
                document.querySelector(`[data-run-name="${runName}"]`)?.classList.add('active');
            }
            
            // Show game view
            document.getElementById('noRunSelected').style.display = 'none';
            document.getElementById('gameView').style.display = 'block';
            
            // Load metadata
            await loadMetadata(runName);
            
            // Load events
            await loadEvents(runName);
            
            // Start polling for new events
            if (pollInterval) {
                clearInterval(pollInterval);
            }
            pollInterval = setInterval(() => pollNewEvents(runName), 2000);
        }

        async function loadMetadata(runName) {
            try {
                const response = await fetch(`/api/runs/${runName}/metadata`);
                const metadata = await response.json();
                
                // Update game status if available
                if (metadata.config) {
                    // Could display config info here
                }
            } catch (error) {
                console.error('Error loading metadata:', error);
            }
        }

        async function loadEvents(runName) {
            try {
                const response = await fetch(`/api/runs/${runName}/events`);
                const events = await response.json();
                
                // Clear existing events
                const eventLog = document.getElementById('eventLog');
                eventLog.innerHTML = '';
                
                // Process events in order
                let gameState = {
                    phase: 'setup',
                    day_number: 0,
                    night_number: 0,
                    alive_count: 10,
                    mafia_count: 3,
                    civilian_count: 7
                };
                
                let players = [];
                
                // Store in window for access by other functions
                window.currentGameState = gameState;
                window.currentPlayers = players;
                
                events.forEach(event => {
                    processEvent(event, gameState, players);
                });
                
                eventsLoaded = events.length;
                updateGameStatus(gameState);
                updatePlayerList(players);
                
                // Scroll to bottom to show newest events
                if (eventLog) {
                    setTimeout(() => {
                        eventLog.scrollTop = eventLog.scrollHeight;
                    }, 0);
                }
            } catch (error) {
                console.error('Error loading events:', error);
            }
        }

        async function pollNewEvents(runName) {
            try {
                const response = await fetch(`/api/runs/${runName}/events/stream?last_position=${eventsLoaded}`);
                const data = await response.json();
                
                if (data.events && data.events.length > 0) {
                    let gameState = window.currentGameState || {
                        phase: 'setup',
                        day_number: 0,
                        night_number: 0,
                        alive_count: 10,
                        mafia_count: 3,
                        civilian_count: 7
                    };
                    let players = window.currentPlayers || [];
                    
                    data.events.forEach(event => {
                        processEvent(event, gameState, players);
                    });
                    
                    window.currentGameState = gameState;
                    window.currentPlayers = players;
                    
                    eventsLoaded = data.position;
                    updateGameStatus(gameState);
                    updatePlayerList(players);
                }
            } catch (error) {
                console.error('Error polling events:', error);
            }
        }

        function processEvent(event, gameState, players) {
            const { event_type, data, timestamp } = event;
            const eventTime = timestamp || new Date().toISOString();
            
            switch (event_type) {
                case 'game_start':
                    addEvent('announcement', `Game started! Players: ${data.players.join(', ')}`, eventTime);
                    addEvent('announcement', `Mafia: ${data.mafia.join(', ')} | Sheriff: ${data.sheriff}`, eventTime);
                    break;
                case 'phase_change':
                    gameState.phase = data.phase;
                    gameState.day_number = data.day_number;
                    gameState.night_number = data.night_number;
                    addEvent('announcement', `Phase: ${data.phase.toUpperCase()} - Day ${data.day_number}, Night ${data.night_number}`, eventTime);
                    break;
                case 'speech':
                    addSpeechEvent(data, eventTime);
                    break;
                case 'nomination':
                    if (data.success) {
                        addEvent('nomination', `Player ${data.nominator} nominated Player ${data.target}`, eventTime);
                    }
                    break;
                case 'voting_start':
                    addEvent('announcement', `Voting started! Nominated: ${data.nominations.join(', ')}`, eventTime);
                    break;
                case 'vote':
                    addEvent('vote', `Player ${data.voter} voted for Player ${data.target}`, eventTime, data.context);
                    break;
                case 'vote_results':
                    let results = 'Vote results: ';
                    for (const [player, count] of Object.entries(data.vote_counts)) {
                        results += `Player ${player}: ${count} votes; `;
                    }
                    addEvent('vote', results, eventTime);
                    break;
                case 'elimination':
                    let reason = data.reason;
                    if (data.voters && data.voters.length > 0) {
                        reason += ` (voted by: ${data.voters.join(', ')})`;
                    }
                    addEvent('elimination', `Player ${data.player_number} eliminated - ${reason}`, eventTime);
                    break;
                case 'night_kill_claim':
                    addEvent('night-action', `[MAFIA] Player ${data.player_number} claims kill on Player ${data.target}`, eventTime, data.context);
                    break;
                case 'night_kill_decision':
                    const role = data.is_don ? 'DON' : 'MAFIA';
                    addEvent('night-action', `[${role}] Decides to kill Player ${data.target}`, eventTime, data.context);
                    break;
                case 'don_check':
                    addEvent('night-action', `[DON] Checked Player ${data.target}: ${data.result}`, eventTime, data.context);
                    break;
                case 'sheriff_check':
                    addEvent('night-action', `[SHERIFF] Checked Player ${data.target}: ${data.result}`, eventTime, data.context);
                    break;
                case 'announcement':
                    addEvent('announcement', `[JUDGE] ${data.message}`, eventTime);
                    break;
                case 'game_state_update':
                    if (data.game_state) {
                        Object.assign(gameState, data.game_state);
                        if (data.game_state.players) {
                            players.length = 0;
                            players.push(...data.game_state.players);
                        }
                        // Track game over state from state updates
                        if (data.game_state.phase === 'game_over' || data.game_state.phase === 'failed') {
                            gameState.phase = data.game_state.phase;
                            gameState.winner = data.game_state.winner;
                        }
                    }
                    break;
                case 'game_over':
                    gameState.phase = 'game_over';
                    gameState.winner = data.winner;
                    gameState.game_over_reason = data.reason;
                    const winner = data.winner === 'red' ? 'Civilians (Red Team)' : 'Mafia (Black Team)';
                    addEvent('announcement', `GAME OVER - ${winner} WIN!`, eventTime);
                    break;
                case 'fatal_error':
                    gameState.phase = 'failed';
                    gameState.winner = null;
                    addEvent('elimination', `FATAL ERROR: ${data.error_message}`, eventTime);
                    break;
                case 'llm_metadata':
                    addMetadataToEventLog(data, eventTime);
                    break;
            }
        }

        function addEvent(type, message, timestamp, contextData = null) {
            const eventLog = document.getElementById('eventLog');
            if (!eventLog) return;
            
            const eventItem = document.createElement('div');
            eventItem.className = `event-item event-${type}`;
            
            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            const hasContext = contextData && contextData.prompt;
            const hasReasoning = contextData && contextData.reasoning && contextData.reasoning !== null;
            const isLLMAgent = hasContext || (contextData && contextData.hasOwnProperty('reasoning'));
            
            let html = `
                <div class="event-time">${timeStr}</div>
                <div class="event-content">${escapeHtml(message)}</div>
            `;
            
            if (isLLMAgent) {
                const contextId = `context-${type}-${Date.now()}-${Math.random().toString(36).substring(2, 11)}`;
                const promptText = contextData.prompt || '';
                const reasoningText = contextData.reasoning || '';
                const showReasoning = isLLMAgent; // Always show reasoning section for LLM agents
                html += `
                    <button class="speech-expand-btn" onclick="toggleContext('${contextId}')">
                        Show LLM Context
                    </button>
                    <div id="${contextId}" class="context-panel" style="display: none;">
                        ${showReasoning ? `
                            <div class="context-header">Model Reasoning:</div>
                            ${hasReasoning ? `
                                <pre class="reasoning-text">${escapeHtml(reasoningText)}</pre>
                            ` : `
                                <pre class="reasoning-text" style="color: #999; font-style: italic;">No reasoning available</pre>
                            `}
                        ` : ''}
                        ${hasContext ? `
                            <div class="context-header" ${showReasoning ? 'style="margin-top: 12px;"' : ''}>LLM Prompt Context:</div>
                            <pre>${escapeHtml(promptText)}</pre>
                        ` : ''}
                    </div>
                `;
            }
            
            eventItem.innerHTML = html;
            eventLog.appendChild(eventItem);
            
            while (eventLog.children.length > 200) {
                const firstChild = eventLog.firstChild;
                if (firstChild) {
                    eventLog.removeChild(firstChild);
                } else {
                    break;
                }
            }
        }

        let contextCounter = 0;
        
        function addSpeechEvent(data, timestamp) {
            const eventLog = document.getElementById('eventLog');
            if (!eventLog) return;
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item event-speech';
            
            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            const hasContext = data.context && data.context.prompt;
            const hasReasoning = data.context && data.context.reasoning && data.context.reasoning !== null;
            const isLLMAgent = hasContext || (data.context && data.context.hasOwnProperty('reasoning'));
            const contextId = `context-${data.player_number}-${data.day_number || '?'}-${++contextCounter}`;
            
            let html = `
                <div class="event-time">${timeStr}</div>
                <div class="event-content">
                    <strong>Player ${data.player_number}:</strong> ${escapeHtml(data.speech)}
                </div>
            `;
            
            if (isLLMAgent) {
                const promptText = data.context.prompt || '';
                const reasoningText = data.context.reasoning || '';
                const showReasoning = isLLMAgent; // Always show reasoning section for LLM agents
                html += `
                    <button class="speech-expand-btn" onclick="toggleContext('${contextId}')">
                        Show LLM Context
                    </button>
                    <div id="${contextId}" class="context-panel" style="display: none;">
                        ${showReasoning ? `
                            <div class="context-header">Model Reasoning:</div>
                            ${hasReasoning ? `
                                <pre class="reasoning-text">${escapeHtml(reasoningText)}</pre>
                            ` : `
                                <pre class="reasoning-text" style="color: #999; font-style: italic;">No reasoning available</pre>
                            `}
                        ` : ''}
                        ${hasContext ? `
                            <div class="context-header" ${showReasoning ? 'style="margin-top: 12px;"' : ''}>LLM Prompt Context:</div>
                            <pre>${escapeHtml(promptText)}</pre>
                        ` : ''}
                    </div>
                `;
            }
            
            eventItem.innerHTML = html;
            eventLog.appendChild(eventItem);
            
            while (eventLog.children.length > 200) {
                const firstChild = eventLog.firstChild;
                if (firstChild) {
                    eventLog.removeChild(firstChild);
                } else {
                    break;
                }
            }
        }

        window.toggleContext = function(contextId) {
            const contextPanel = document.getElementById(contextId);
            const button = contextPanel.previousElementSibling;
            
            if (contextPanel.style.display === 'none') {
                contextPanel.style.display = 'block';
                button.textContent = 'Hide LLM Context';
            } else {
                contextPanel.style.display = 'none';
                button.textContent = 'Show LLM Context';
            }
        };

        function addMetadataToEventLog(data, timestamp) {
            const promptTokens = data.prompt_tokens || 0;
            const completionTokens = data.completion_tokens || 0;
            const totalTokens = data.total_tokens || 0;
            const latency = data.latency_ms ? parseFloat(data.latency_ms).toFixed(0) : 'N/A';
            
            const metadataText = `[LLM] Player ${data.player_number} (${escapeHtml(data.action_type || 'llm_call')}): ` +
                `Prompt: ${promptTokens.toLocaleString()}, ` +
                `Completion: ${completionTokens.toLocaleString()}, ` +
                `Total: ${totalTokens.toLocaleString()}, ` +
                `Latency: ${latency}ms, ` +
                `Model: ${escapeHtml(data.model || 'unknown')}`;
            
            const eventItem = document.createElement('div');
            eventItem.className = 'event-item event-llm-metadata';
            
            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString() : new Date().toLocaleTimeString();
            eventItem.innerHTML = `
                <div class="event-time">${timeStr}</div>
                <div class="event-content">${metadataText}</div>
                <div class="metadata-details">
                    <div><strong>Prompt:</strong> ${promptTokens.toLocaleString()}</div>
                    <div><strong>Completion:</strong> ${completionTokens.toLocaleString()}</div>
                    <div><strong>Total:</strong> ${totalTokens.toLocaleString()}</div>
                    <div><strong>Latency:</strong> ${latency}ms</div>
                </div>
            `;
            
            const eventLog = document.getElementById('eventLog');
            if (!eventLog) return;
            
            eventLog.appendChild(eventItem);
            
            while (eventLog.children.length > 200) {
                const firstChild = eventLog.firstChild;
                if (firstChild) {
                    eventLog.removeChild(firstChild);
                } else {
                    break;
                }
            }
        }

        function updateGameStatus(gameState) {
            const phaseBadge = document.getElementById('phaseBadge');
            const dayNumber = document.getElementById('dayNumber');
            const nightNumber = document.getElementById('nightNumber');
            const aliveCount = document.getElementById('aliveCount');
            const mafiaCount = document.getElementById('mafiaCount');
            const civilianCount = document.getElementById('civilianCount');
            const eliminatedCount = document.getElementById('eliminatedCount');
            const gameOutcome = document.getElementById('gameOutcome');

            const phase = gameState.phase || 'setup';
            const phaseClass = `phase-${phase.replace('_', '-')}`;
            phaseBadge.className = `status-badge ${phaseClass}`;
            phaseBadge.textContent = phase.toUpperCase().replace('_', ' ');

            dayNumber.textContent = gameState.day_number || 0;
            nightNumber.textContent = gameState.night_number || 0;
            aliveCount.textContent = gameState.alive_count || 0;
            mafiaCount.textContent = gameState.mafia_count || 0;
            civilianCount.textContent = gameState.civilian_count || 0;
            eliminatedCount.textContent = (gameState.alive_count ? 10 - gameState.alive_count : 0);

            // Show game outcome if game is over
            if (phase === 'game_over' && gameState.winner) {
                const winnerText = gameState.winner === 'red' ? 'Civilians Win' : 'Mafia Win';
                gameOutcome.textContent = `ðŸ† ${winnerText}`;
                gameOutcome.style.display = 'block';
                gameOutcome.style.color = gameState.winner === 'red' ? '#e74c3c' : '#2c3e50';
            } else if (phase === 'failed') {
                gameOutcome.textContent = 'âŒ Game Failed';
                gameOutcome.style.display = 'block';
                gameOutcome.style.color = '#e67e22';
            } else {
                gameOutcome.style.display = 'none';
            }
        }

        function updatePlayerList(players) {
            const playerList = document.getElementById('playerList');
            playerList.innerHTML = '';
            
            players.forEach(player => {
                const li = document.createElement('li');
                li.className = `player-item ${player.is_alive ? 'player-alive' : 'player-eliminated'} team-${player.team.toLowerCase()}`;
                
                li.innerHTML = `
                    <div style="font-weight: bold; font-size: 0.95em; color: #667eea;">P${player.number}</div>
                    <div style="font-size: 0.8em; color: #495057; font-weight: 500;">${player.role}</div>
                    <div style="font-size: 0.75em; color: #6c757d;">
                        ${player.team} â€¢ ${player.is_alive ? 'âœ“' : 'âœ—'}
                    </div>
                `;
                
                playerList.appendChild(li);
            });
        }


        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // Initial load
        loadRuns();
    </script>
</body>
</html>

